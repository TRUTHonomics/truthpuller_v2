# Phase 2 Prompt: Cluster Comparison
# Script: scripts/analyze_clusters_phase2.py
# Compares posts within a cluster to determine the most likely trigger

[meta]
name = "phase2_cluster_comparison"
version = "2.0"
description = "Cluster-level LLM analysis to identify trigger post and mechanism"

[template]
# Placeholders: {interval}, {return_pct}, {sigma}, {trigger_time}, {post_count}, {posts_section}
user_prompt = """
You are comparing posts within a cluster to decide which Trump post most likely triggered a specific TRUMP price movement event.

You see:
- One price movement event (with sigma, return %, interval, and timing).
- Several posts in the same cluster window.
- Phase 1 scores for each post (impact_likelihood, suspicion_score, mechanism scores, etc.).

Your task is to:
1) Select exactly ONE post as the best candidate trigger for this price movement.
2) Decide which mechanism (A, B, or C) best explains the event.
3) Estimate how likely it is that this price movement was actually caused by Trump's post(s) in this cluster.

## Mechanisms

Mechanism A - Public market reaction
- Post goes viral, attracts attention, triggers retail trading.
- Often high impact_likelihood, strong sentiment or clear news, and obvious public relevance.

Mechanism B - Coordinated signals
- Trump uses Truth Social as a coded signal to associates or insiders.
- Often high suspicion_score and mechanism_b_score in Phase 1.
- Indicators:
  - Specific or repeating numbers, times, or dates.
  - Posts with low public news value but strong patterns.
  - Odd timing relative to normal posting behaviour.

Mechanism C - Coincidence
- Price movement is unrelated to these posts.
- Typical when:
  - All posts have low impact_likelihood.
  - mechanism_c_score is high for most posts.
  - Content is generic and not obviously market relevant.
  - Timing does not line up well with the move.

## Cluster context

PRICE EVENT:
- Interval: {interval}
- Price movement: {return_pct:+.2f}% ({sigma:.2f} sigma)
- Trigger time: {trigger_time}
- Number of posts: {post_count}

POSTS IN CLUSTER (chronological order, with Phase 1 scores):

{posts_section}

## Evaluation criteria

When comparing posts in the cluster, use:

1. Phase 1 scores
   - impact_likelihood
   - suspicion_score
   - news_value
   - mechanism_a/b/c_score

2. Timing
   - How close is each post's timestamp to the trigger kline time and close?

3. Content fit
   - Is the content plausibly able to move TRUMP price given normal market behaviour or a coded signal narrative?

4. Combined effect
   - Check if TWO OR MORE posts together are more plausible than any single post (e.g. a build-up of hype).

You MUST always pick one best candidate post, even if mechanism C (coincidence) is the most likely mechanism. In that case, choose the post that is the least unlikely candidate.

## JSON output format

Return ONLY valid JSON. No extra text, no markdown, no comments.

Use this schema:

{{
  "selected_position": 1,
  "selected_post_id": "post_id_here",
  "confidence": 0.00,
  "rankings": [
    {{"position": 1, "post_id": "id", "score": 0.00, "reason": "..."}},
    {{"position": 2, "post_id": "id", "score": 0.00, "reason": "..."}}
  ],
  "likely_mechanism": "A" or "B" or "C",
  "reasoning": "1-3 short sentences explaining why this post and mechanism are most plausible",
  "suspicious_elements": "brief note on suspicious patterns, if any, or null",
  "causation_likelihood": 0.00,
  "runner_up_position": 2,
  "combined_effect": false
}}

Field-specific rules:

- selected_position:
  - 1-based index of the chosen post in the cluster list (1 = first post, 2 = second, etc.).
  - Must always be a valid index.

- selected_post_id:
  - Copy exactly the post_id of the chosen post.

- confidence:
  - Your confidence that you chose the correct trigger POST within this cluster.
  - 0.00 = pure guess
  - 0.50 = moderate confidence
  - 1.00 = very confident.

- rankings:
  - Rank ALL posts in the cluster from most to least likely trigger.
  - Include position, post_id, score (0.0-1.0), and brief reason.

- likely_mechanism:
  - "A" if the move is best explained by public reaction to the content.
  - "B" if a coordinated or coded signal explanation is more plausible.
  - "C" if the movement is likely unrelated to the posts (coincidence).

- reasoning:
  - 1-3 short sentences.
  - Refer to Phase 1 scores and timing qualitatively (e.g. "highest impact_likelihood and closest timing").
  - Do NOT restate the full post content.

- suspicious_elements:
  - Only fill if there is something notable (strange numbers, times, or phrasing).
  - Otherwise use null.

- causation_likelihood:
  - Your estimate of the absolute probability that the price movement was actually caused (fully or mostly) by Trump's post(s) in this cluster.
  - 0.00 = almost certainly unrelated
  - 0.50 = possibly related, but uncertain
  - 1.00 = very likely caused by these posts.

- runner_up_position:
  - If there is a clear second-best candidate, give its 1-based index.
  - Use null if no meaningful runner-up exists or if there is only 1 post.

- combined_effect:
  - true  = you believe that multiple posts in the cluster together likely caused the move (e.g. sequence of posts building hype).
  - false = you believe a single post explanation is sufficient or the move is mostly coincidence.
"""

[output_schema]
# JSON schema fields for validation
fields = [
  "selected_position",
  "selected_post_id",
  "confidence",
  "rankings",
  "likely_mechanism",
  "reasoning",
  "suspicious_elements",
  "causation_likelihood",
  "runner_up_position",
  "combined_effect"
]

# Valid values for likely_mechanism
likely_mechanism_values = ["A", "B", "C"]

